<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TOEIC Tap Quiz</title>
  <meta name="theme-color" content="#111" />
  <style>
    :root { --bg:#0f1115; --fg:#e6e9ef; --muted:#9aa1ac; --card:#171a21; --accent:#7cdeff; --green:#4ade80; --red:#fb7185; --yellow:#facc15; --btn:#1f2430; --btn-press:#262c38; --border:#2a2f3a; --shadow: 0 8px 24px rgba(0,0,0,.35);} 
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button,.file{background:var(--btn);color:var(--fg);border:1px solid var(--border);border-radius:14px;padding:10px 14px;font-size:15px;box-shadow:var(--shadow)}
    button:active{background:var(--btn-press);transform:translateY(1px)}
    .row{margin-top:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .kicker{color:var(--yellow);font-size:12px;letter-spacing:.1em;text-transform:uppercase}
    .qtext{font-size:20px;line-height:1.35}
    .qja{margin-top:6px;color:var(--muted);font-size:16px}
    .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:14px}
    .choice{display:flex;gap:10px;align-items:center;background:var(--btn);border:1px solid var(--border);padding:14px;border-radius:14px;font-size:18px;text-align:left}
    .choice .label{width:28px;height:28px;border-radius:999px;display:grid;place-items:center;background:#11151c;border:1px solid var(--border);font-weight:600}
    .choice.correct{outline:2px solid var(--green)}
    .choice.wrong{outline:2px solid var(--red)}
    .expl{margin-top:6px;color:var(--muted);font-size:14px}
    .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px}
    .progress{height:10px;width:100%;background:#12151c;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#9effa2)}
    .pill{font-size:12px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hidden{display:none}
    @media (min-width:620px){.choices{grid-template-columns:1fr 1fr}}
    textarea{width:100%;height:260px;background:#0c0f14;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
    input[type="url"],input[type="text"]{width:100%;background:#0c0f14;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TOEIC Tap Quiz <span class="pill" id="version"></span></h1>
      <div class="controls">
        <button id="btnPrev">◀</button>
        <button id="btnNext">▶</button>
        <button id="btnShuffle">Shuffle</button>
        <button id="btnSpeak">🔊 TTS</button>
        <button id="btnExport">Export</button>
        <label class="file">Import <input id="fileInput" type="file" accept="application/json" class="hidden"></label>
        <button id="btnEdit">Edit</button>
        <button id="btnSource">Set Source</button>
        <button id="btnRefresh">Refresh</button>
      </div>
    </header>

    <div class="row card" id="quiz">
      <div class="kicker" id="kicker">Question</div>
      <div class="qtext" id="qtext">Loading…</div>
      <div class="qja" id="qja"></div>
      <div class="choices" id="choices"></div>
      <div class="expl hidden" id="explain"></div>
      <div class="footer">
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="pill" id="meta">0/0</div>
        <button id="btnAdvance">Next ▶</button>
      </div>
    </div>

    <div class="row card hidden" id="editor">
      <div class="kicker">Editor</div>
      <p class="pill">編集して「Apply」で保存。/ ImportでJSON読み込み。<br>
      choices は文字列配列 ["A","B",…] でも、オブジェクト配列 [{t:"A",note:"説明"},…] でもOK。後者なら解答後に各選択肢の説明が表示されます。</p>
      <textarea id="editArea"></textarea>
      <div class="grid2" style="margin-top:10px;">
        <button id="btnApply">Apply</button>
        <button id="btnCancel">Cancel</button>
      </div>
    </div>

    <div class="row card hidden" id="sourcePanel">
      <div class="kicker">Live Source URL</div>
      <input id="srcInput" type="url" placeholder="https://example.com/quiz.json" />
      <div class="grid2" style="margin-top:10px;">
        <button id="btnSaveSrc">Save Source</button>
        <button id="btnCloseSrc">Close</button>
      </div>
    </div>
  </div>

  <script>
  const VERSION = 'v1.4';
  const el=id=>document.getElementById(id);

  function normalize(arr){
    return arr.map(o=>({
      q:o.q,
      choices:(o.choices||[]).map(c=> typeof c==="string" ? {t:c,note:''} : {t:c.t||c.text||'',note:c.note||c.explain||''}),
      answer:o.answer,
      ex:o.ex||'',
      ja:o.ja||''
    }));
  }

  let state={i:0,q:[],answered:false};

  function render(){
    if(!state.q.length) return;
    const item=state.q[state.i];
    el('kicker').textContent=`Question ${state.i+1} / ${state.q.length}`;
    el('qtext').textContent=item.q;
    const ja=item.ja||'';
    el('qja').textContent=ja;
    if(ja){el('qja').classList.remove('hidden')}else{el('qja').classList.add('hidden')}
    const c=el('choices'); c.innerHTML='';
    item.choices.forEach((choice,idx)=>{
      const btn=document.createElement('button');
      btn.className='choice'; btn.setAttribute('data-idx',idx);
      btn.innerHTML=`<span class="label">${String.fromCharCode(65+idx)}</span><span>${choice.t}</span>`;
      btn.addEventListener('click',()=>select(idx));
      c.appendChild(btn);
    });
    el('bar').style.width=(state.i/state.q.length*100)+'%';
    el('meta').textContent=`${state.i+1}/${state.q.length}`;
    el('explain').classList.add('hidden');
    state.answered=false;
  }

  function select(idx){
    if(state.answered) return; state.answered=true;
    const item=state.q[state.i];
    [...document.querySelectorAll('.choice')].forEach((b,i)=>{
      b.classList.remove('correct','wrong');
      if(i===item.answer) b.classList.add('correct');
      if(i===idx && i!==item.answer) b.classList.add('wrong');
      const note=item.choices[i]?.note||'';
      if(note){
        const n=document.createElement('div');
        n.className='expl';
        n.textContent=(i===item.answer?'✓ ':'• ')+note;
        b.insertAdjacentElement('afterend',n);
      }
    });
    const letters=['A','B','C','D'];
    el('explain').innerHTML=`<b>${idx===item.answer?'✅ Correct':'❌ Incorrect'}</b> — Answer: <b>${letters[item.answer]}</b><br>${item.ex}`;
    el('explain').classList.remove('hidden');
  }

  function next(){state.i=Math.min(state.i+1,state.q.length-1);render();}
  function prev(){state.i=Math.max(state.i-1,0);render();}

  document.getElementById('btnNext').onclick=next;
  document.getElementById('btnPrev').onclick=prev;
  document.getElementById('btnAdvance').onclick=next;

  document.getElementById('btnShuffle').onclick=()=>{shuffle(state.q);state.i=0;render();};

  function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

  document.getElementById('btnExport').onclick=()=>{
    const blob=new Blob([JSON.stringify(state.q,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='quiz.json'; a.click();
  };

  document.getElementById('fileInput').addEventListener('change',e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=()=>{state.q=normalize(JSON.parse(r.result));state.i=0;render();};r.readAsText(f);} });

  document.getElementById('btnEdit').onclick=()=>{el('editor').classList.remove('hidden');el('quiz').classList.add('hidden');el('editArea').value=JSON.stringify(state.q,null,2);};
  document.getElementById('btnCancel').onclick=()=>{el('editor').classList.add('hidden');el('quiz').classList.remove('hidden');};
  document.getElementById('btnApply').onclick=()=>{try{state.q=normalize(JSON.parse(el('editArea').value));state.i=0;render();el('editor').classList.add('hidden');el('quiz').classList.remove('hidden');}catch(e){alert('Invalid JSON');}};

  document.getElementById('btnSource').onclick=()=>{el('sourcePanel').classList.remove('hidden');el('quiz').classList.add('hidden');};
  document.getElementById('btnCloseSrc').onclick=()=>{el('sourcePanel').classList.add('hidden');el('quiz').classList.remove('hidden');};
  document.getElementById('btnSaveSrc').onclick=()=>{localStorage.setItem('quiz_src',el('srcInput').value.trim());alert('Saved');};
  document.getElementById('btnRefresh').onclick=async()=>{
    const src=localStorage.getItem('quiz_src'); if(!src) return alert('No source URL');
    const res=await fetch(src+"?"+Date.now());
    state.q=normalize(await res.json());state.i=0;render();
  };

  (async()=>{const src=localStorage.getItem('quiz_src');if(src){try{const res=await fetch(src);state.q=normalize(await res.json());render();}catch(_){}}})();
  </script>
</body>
</html>
